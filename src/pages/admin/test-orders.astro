---
/**
 * Test Orders Page
 * 
 * Admin page for testing the complete order flow in a safe environment
 * without processing real payments or creating real orders.
 */

import AdminLayout from '@layouts/AdminLayout.astro';
import TestOrderPanel from '@components/admin/TestOrderPanel';
import { validateTestEnvironment, displayTestWarnings } from '@lib/testing/config';

export const prerender = false;

// Validate test environment
let testConfig;
let validationError;
let environmentStatus;

try {
  testConfig = validateTestEnvironment();
  displayTestWarnings();
  
  // Create environment status for client component
  environmentStatus = {
    success: true,
    configured: true,
    config: testConfig,
  };
} catch (error) {
  console.error('Test environment validation failed:', error);
  validationError = error instanceof Error ? error.message : 'Unknown validation error';
  
  environmentStatus = {
    success: false,
    configured: false,
    error: validationError,
  };
}

const title = 'Test Orders - Admin';
const description = 'Test the complete order flow in a safe environment';
---

<AdminLayout title={title} description={description}>
  <main class="space-y-6">
    <!-- Header -->
    <div class="bg-white shadow rounded-lg p-6">
      <h1 class="text-2xl font-bold text-gray-900 mb-2">Test Order Flow</h1>
      <p class="text-gray-600">
        Test the complete order flow including cart validation, payment processing, and order creation
        in a safe environment without processing real payments or creating real orders.
      </p>
    </div>

    <!-- Test Environment Status -->
    <div class="bg-white shadow rounded-lg p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Test Environment Status</h2>
      
      {validationError ? (
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
          <h3 class="font-medium text-red-800 mb-2">Configuration Error</h3>
          <p class="text-sm text-red-600 mb-4">{validationError}</p>
          <div class="bg-red-100 rounded-lg p-3">
            <h4 class="font-medium text-red-800 mb-2">Quick Fix:</h4>
            <ol class="text-sm text-red-700 list-decimal list-inside space-y-1">
              <li>Copy <code>.env.example</code> to <code>.env</code></li>
              <li>Get your Stripe test keys from <a href="https://dashboard.stripe.com/test/apikeys" target="_blank" class="underline">Stripe Dashboard</a></li>
              <li>Add your Printful API key from <a href="https://www.printful.com/dashboard/store" target="_blank" class="underline">Printful Dashboard</a></li>
              <li>Restart the development server</li>
            </ol>
          </div>
        </div>
      ) : testConfig ? (
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Stripe Status -->
          <div class="border rounded-lg p-4">
            <h3 class="font-medium text-gray-900 mb-2">Stripe Configuration</h3>
            <div class="space-y-2">
              <div class="flex items-center">
                <span class="text-sm text-gray-600">Status:</span>
                <span class={`ml-2 px-2 py-1 rounded-full text-xs font-medium ${
                  testConfig.stripe.testMode 
                    ? 'bg-green-100 text-green-800' 
                    : 'bg-yellow-100 text-yellow-800'
                }`}>
                  {testConfig.stripe.testMode ? 'Test Mode' : 'Live Mode'}
                </span>
              </div>
              <div class="flex items-center">
                <span class="text-sm text-gray-600">Keys:</span>
                <span class={`ml-2 px-2 py-1 rounded-full text-xs font-medium ${
                  testConfig.stripe.hasKeys 
                    ? 'bg-green-100 text-green-800' 
                    : 'bg-red-100 text-red-800'
                }`}>
                  {testConfig.stripe.hasKeys ? 'Configured' : 'Missing'}
                </span>
              </div>
            </div>
          </div>

          <!-- Printful Status -->
          <div class="border rounded-lg p-4">
            <h3 class="font-medium text-gray-900 mb-2">Printful Configuration</h3>
            <div class="space-y-2">
              <div class="flex items-center">
                <span class="text-sm text-gray-600">Status:</span>
                <span class={`ml-2 px-2 py-1 rounded-full text-xs font-medium ${
                  testConfig.printful.sandboxMode 
                    ? 'bg-green-100 text-green-800' 
                    : 'bg-yellow-100 text-yellow-800'
                }`}>
                  {testConfig.printful.sandboxMode ? 'Sandbox Mode' : 'Production Mode'}
                </span>
              </div>
              <div class="flex items-center">
                <span class="text-sm text-gray-600">API Key:</span>
                <span class={`ml-2 px-2 py-1 rounded-full text-xs font-medium ${
                  testConfig.printful.hasKey 
                    ? 'bg-green-100 text-green-800' 
                    : 'bg-red-100 text-red-800'
                }`}>
                  {testConfig.printful.hasKey ? 'Configured' : 'Missing'}
                </span>
              </div>
            </div>
          </div>
        </div>
      ) : (
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <h3 class="font-medium text-yellow-800 mb-2">Environment Not Configured</h3>
          <p class="text-sm text-yellow-600">
            Please set up your environment variables to use the test features.
          </p>
        </div>
      )}
    </div>

    <!-- Test Order Panel -->
    <TestOrderPanel client:load environmentStatusJson={JSON.stringify(environmentStatus)} />

    <!-- Documentation -->
    <div class="bg-white shadow rounded-lg p-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Test Documentation</h2>
      
      <div class="space-y-4">
        <div>
          <h3 class="font-medium text-gray-900 mb-2">Stripe Test Cards</h3>
          <div class="bg-gray-50 rounded-lg p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div>
                <strong>Success:</strong> 4242424242424242
              </div>
              <div>
                <strong>Declined:</strong> 4000000000000002
              </div>
              <div>
                <strong>Expired:</strong> 4000000000000069
              </div>
              <div>
                <strong>Incorrect CVC:</strong> 4000000000000127
              </div>
            </div>
          </div>
        </div>

        <div>
          <h3 class="font-medium text-gray-900 mb-2">Test Flow</h3>
          <ol class="list-decimal list-inside space-y-1 text-sm text-gray-600">
            <li>Click "Create Test Cart" to generate a test cart with sample products</li>
            <li>Click "Test Checkout Flow" to simulate the complete checkout process</li>
            <li>Use test credit card numbers above to simulate different payment scenarios</li>
            <li>Orders created in test mode will not be fulfilled or charged</li>
          </ol>
        </div>

        <div>
          <h3 class="font-medium text-gray-900 mb-2">Environment Variables</h3>
          <div class="bg-gray-50 rounded-lg p-4">
            <div class="space-y-2 text-sm">
              <div><strong>STRIPE_SECRET_KEY:</strong> Use sk_test_* keys for testing</div>
              <div><strong>PUBLIC_STRIPE_PUBLISHABLE_KEY:</strong> Use pk_test_* keys for testing</div>
              <div><strong>PRINTFUL_SANDBOX_MODE:</strong> Set to 'true' for testing</div>
              <div><strong>ENABLE_TEST_MODE:</strong> Set to 'true' to enable test utilities</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</AdminLayout>