---
// Server-side rendering for auth
export const prerender = false;

import AdminLayout from "../../layouts/AdminLayout.astro";
import PrintfulService from "../../lib/printful/service";
import PrintfulProductSync from "../../lib/printful/product-sync";
import { createServerSupabaseClient } from "../../lib/supabase";

// Get Printful service
const printfulService = PrintfulService.getInstance();
let products: any[] = [];
let error: Error | null = null;
let dbProducts: any[] = [];
let dbVariants: any[] = [];
let dbError: any = null;

try {
  // Get products from API
  products = await printfulService.getAllProducts();
  
  // Get products from database
  const supabase = createServerSupabaseClient({ cookies: Astro.cookies });
  const { data: productsData, error: productsError } = await supabase
    .from('products')
    .select('*')
    .limit(10);
    
  if (productsError) {
    dbError = productsError;
  } else {
    dbProducts = productsData || [];
    
    // If we have products, get some variants too
    if (dbProducts.length > 0) {
      const { data: variantsData } = await supabase
        .from('product_variants')
        .select('*')
        .eq('product_id', dbProducts[0].id)
        .limit(5);
        
      dbVariants = variantsData || [];
    }
  }
} catch (e) {
  error = e as Error;
}
---

<AdminLayout title="Printful API Test">
  <div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">Printful API Test</h1>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- API Products -->
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-bold mb-4">Printful API Products</h2>
        
        {error ? (
          <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
            <p class="font-bold">Error</p>
            <p>{error.message}</p>
          </div>
        ) : products.length === 0 ? (
          <p class="text-gray-500">No products found in Printful API.</p>
        ) : (
          <div class="space-y-4">
            <p class="text-green-600 font-medium">
              Found {products.length} products in Printful API
            </p>
            
            <ul class="divide-y">
              {products.map((product) => (
                <li class="py-3">
                  <div class="flex items-start">
                    {product.sync_product.thumbnail_url && (
                      <img 
                        src={product.sync_product.thumbnail_url} 
                        alt={product.sync_product.name}
                        class="w-16 h-16 object-cover rounded mr-4"
                      />
                    )}
                    <div>
                      <p class="font-medium">{product.sync_product.name}</p>
                      <p class="text-sm text-gray-500">ID: {product.sync_product.id}</p>
                      <p class="text-sm text-gray-500">Variants: {product.sync_product.variants}</p>
                    </div>
                  </div>
                </li>
              ))}
            </ul>
          </div>
        )}
      </div>
      
      <!-- Database Products -->
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-bold mb-4">Database Products</h2>
        
        {dbError ? (
          <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
            <p class="font-bold">Database Error</p>
            <p>{dbError.message}</p>
          </div>
        ) : dbProducts.length === 0 ? (
          <p class="text-gray-500">No products found in database. Try syncing first.</p>
        ) : (
          <div class="space-y-4">
            <p class="text-green-600 font-medium">
              Found {dbProducts.length} products in database
            </p>
            
            <ul class="divide-y">
              {dbProducts.map((product) => (
                <li class="py-3">
                  <div>
                    <p class="font-medium">{product.name}</p>
                    <p class="text-sm text-gray-500">ID: {product.id}</p>
                    <p class="text-sm text-gray-500">Printful ID: {product.printful_id}</p>
                    {product.thumbnail_url && (
                      <img 
                        src={product.thumbnail_url} 
                        alt={product.name}
                        class="w-16 h-16 object-cover rounded mt-2"
                      />
                    )}
                  </div>
                </li>
              ))}
            </ul>
            
            {dbVariants.length > 0 && (
              <div class="mt-6">
                <h3 class="text-lg font-medium mb-2">Variants for {dbProducts[0].name}</h3>
                <ul class="divide-y">
                  {dbVariants.map((variant) => (
                    <li class="py-2">
                      <p class="font-medium">{variant.name}</p>
                      <p class="text-sm text-gray-500">SKU: {variant.sku}</p>
                      <p class="text-sm text-gray-500">Price: ${variant.retail_price}</p>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        )}
      </div>
    </div>
    
    <div class="mt-6">
      <a 
        href="/admin/products/sync" 
        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
      >
        Go to Sync Page
      </a>
    </div>
  </div>
</AdminLayout> 